<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claire's Adventure - Admin Panel</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 102, 0, 0.1);
            border-radius: 15px;
            border: 2px solid #ff6600;
        }

        .admin-header h1 {
            color: #ff6600;
            margin: 0;
            font-size: 2.5em;
        }

        .admin-header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        .admin-section h3 {
            color: #ff6600;
            margin-top: 0;
            font-size: 1.3em;
            border-bottom: 2px solid #ff6600;
            padding-bottom: 10px;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffd700;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        button {
            background: linear-gradient(145deg, #ff6600, #e55100);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: linear-gradient(145deg, #e55100, #d84315);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        input[type="number"], input[type="range"], select {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #ff6600;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
        }

        .status-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-on {
            background: #4caf50;
            color: white;
        }

        .status-off {
            background: #f44336;
            color: white;
        }

        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .action-buttons button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 16px;
        }

        .back-button {
            background: linear-gradient(145deg, #666, #555);
        }

        .back-button:hover {
            background: linear-gradient(145deg, #555, #444);
        }

        .coordinates {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .analytics-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff6600;
        }

        .game-section {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            border: 2px solid rgba(255, 102, 0, 0.5);
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ff6600;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .game-ui > * {
            pointer-events: auto;
        }

        .game-ui div {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #stars {
            top: 10px;
            left: 10px;
            font-size: 18px;
        }

        #lives {
            top: 10px;
            left: 150px;
            font-size: 18px;
        }

        #powerupStatus {
            top: 50px;
            left: 10px;
            background: rgba(255, 215, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            color: #333;
        }

        #bossHealthBar, #playerHealthBar {
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        #bossHealthBar {
            top: 20px;
        }

        #playerHealthBar {
            top: 80px;
        }

        #bossControls {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        #bossControls button {
            padding: 10px 15px;
            background: linear-gradient(145deg, #ff6600, #e55100);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        #bossControls button:hover {
            background: linear-gradient(145deg, #e55100, #d84315);
            transform: translateY(-2px);
        }

        .game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ff6600;
            min-width: 300px;
        }

        .game-message button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #ff6600;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #adminStatusGame {
            top: 10px;
            right: 10px;
            background: rgba(255, 102, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .coordinates {
                grid-template-columns: 1fr;
            }

            .game-container {
                height: 400px;
            }

            #bossHealthBar, #playerHealthBar {
                width: 250px;
            }

            #bossControls {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>👑 ADMIN CONTROL PANEL</h1>
        <p>Claire's Adventure - Administrative Controls</p>
        <div id="adminStatus">Status: <span id="statusText">AUTHENTICATED</span></div>
    </div>

    <div class="admin-grid">
        <!-- Player Controls -->
        <div class="admin-section">
            <h3>🎮 Player Controls</h3>
            
            <div class="control-group">
                <div class="control-row">
                    <button onclick="toggleGodMode()">Toggle God Mode</button>
                    <span id="godModeStatus" class="status-indicator status-off">OFF</span>
                </div>
            </div>

            <div class="control-group">
                <div class="control-row">
                    <button onclick="toggleInfiniteLives()">Infinite Lives</button>
                    <span id="infiniteLivesStatus" class="status-indicator status-off">OFF</span>
                </div>
            </div>

            <div class="control-group">
                <label>Speed Multiplier</label>
                <div class="control-row">
                    <input type="range" id="speedMultiplier" min="0.1" max="5" step="0.1" value="1" oninput="updateSpeedMultiplier(this.value)">
                    <span id="speedValue" class="range-value">1.0x</span>
                </div>
            </div>

            <div class="control-group">
                <label>Jump Height</label>
                <div class="control-row">
                    <input type="range" id="jumpHeight" min="0.5" max="3" step="0.1" value="1" oninput="updateJumpHeight(this.value)">
                    <span id="jumpValue" class="range-value">1.0x</span>
                </div>
            </div>

            <div class="control-group">
                <label>Set Star Count</label>
                <div class="control-row">
                    <input type="number" id="starCount" min="0" max="999" value="0">
                    <button onclick="setStarCount()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Game State Management -->
        <div class="admin-section">
            <h3>🎯 Game State</h3>
            
            <div class="control-group">
                <button onclick="resetLevel()">Reset Level</button>
                <button onclick="skipToVictory()">Skip to Victory</button>
            </div>

            <div class="control-group">
                <div class="control-row">
                    <button onclick="togglePhysics()">Toggle Physics</button>
                    <span id="physicsStatus" class="status-indicator status-on">ON</span>
                </div>
            </div>

            <div class="control-group">
                <div class="control-row">
                    <button onclick="pauseGame()">Pause/Resume</button>
                    <span id="pauseStatus" class="status-indicator status-off">RUNNING</span>
                </div>
            </div>

            <div class="control-group">
                <button onclick="unlockAllAreas()">Unlock All Areas</button>
            </div>
        </div>

        <!-- Teleport Controls -->
        <div class="admin-section">
            <h3>🚀 Teleport</h3>
            
            <div class="control-group">
                <button onclick="teleportToSpawn()">Spawn Point</button>
                <button onclick="teleportToBoss()">Boss Arena</button>
            </div>

            <div class="control-group">
                <button onclick="teleportToPowerUp()">Power-Up Location</button>
                <button onclick="teleportToEnd()">End Platform</button>
            </div>

            <div class="control-group">
                <label>Custom Coordinates</label>
                <div class="coordinates">
                    <input type="number" id="teleportX" placeholder="X" step="0.1">
                    <input type="number" id="teleportY" placeholder="Y" step="0.1">
                    <input type="number" id="teleportZ" placeholder="Z" step="0.1">
                </div>
                <button onclick="teleportToCoordinates()" style="width: 100%; margin-top: 10px;">Teleport</button>
            </div>
        </div>

        <!-- Visual Controls -->
        <div class="admin-section">
            <h3>🎨 Visual Effects</h3>
            
            <div class="control-group">
                <div class="control-row">
                    <button onclick="toggleWireframe()">Wireframe Mode</button>
                    <span id="wireframeStatus" class="status-indicator status-off">OFF</span>
                </div>
            </div>

            <div class="control-group">
                <label>Lighting</label>
                <div class="control-row">
                    <input type="range" id="lightingBrightness" min="0.1" max="3" step="0.1" value="1" oninput="updateLighting(this.value)">
                    <span id="lightingValue" class="range-value">1.0x</span>
                </div>
            </div>

            <div class="control-group">
                <div class="control-row">
                    <button onclick="toggleGrid()">Coordinate Grid</button>
                    <span id="gridStatus" class="status-indicator status-off">OFF</span>
                </div>
            </div>
        </div>

        <!-- Analytics -->
        <div class="admin-section">
            <h3>📊 Analytics</h3>
            
            <div class="analytics-display">
                <strong>Session Info</strong><br>
                Time Played: <span id="timePlayed">00:00</span><br>
                Deaths: <span id="deathCount">0</span><br>
                Stars Collected: <span id="starsCollected">0</span>
            </div>

            <div class="analytics-display">
                <strong>Performance</strong><br>
                FPS: <span id="fpsCounter">60</span><br>
                Position: <span id="playerPosition">0, 0, 0</span><br>
                Status: <span id="gameStatus">Ready</span>
            </div>

            <div class="control-group">
                <button onclick="clearAnalytics()">Clear Analytics</button>
                <button onclick="exportData()">Export Data</button>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button onclick="resetEmbeddedGame()">🔄 Reset Game</button>
        <button onclick="toggleGameFullscreen()">📺 Toggle Fullscreen</button>
        <button class="back-button" onclick="goBack()">← Back to Main</button>
    </div>

    <!-- Embedded Game Section -->
    <div class="game-section">
        <h2 style="text-align: center; color: #ff6600; margin-bottom: 20px;">🎮 Live Game Preview</h2>
        <div id="gameContainer" class="game-container">
            <!-- Game UI Elements -->
            <div id="gameUI" class="game-ui">
                <div id="stars">⭐ Stars: 0</div>
                <div id="lives">❤️ Lives: 3</div>
                <div id="powerupStatus" style="display: none;">
                    ⚡ Claire is Awesome! Time: <span id="powerupTimer">5</span>s
                </div>
                
                <!-- Boss Fight UI -->
                <div id="bossHealthBar" style="display: none;">
                    <div style="color: white; font-weight: bold; margin-bottom: 5px;">Boss Health</div>
                    <div style="background: rgba(139, 0, 0, 0.7); height: 20px; border-radius: 10px;">
                        <div id="bossHealth" style="background: linear-gradient(90deg, #ff4444, #cc0000); height: 100%; width: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div id="playerHealthBar" style="display: none;">
                    <div style="color: white; font-weight: bold; margin-bottom: 5px;">Player Health</div>
                    <div style="background: rgba(0, 0, 0, 0.7); height: 20px; border-radius: 10px;">
                        <div id="playerHealth" style="background: linear-gradient(90deg, #44ff44, #00cc00); height: 100%; width: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <!-- Boss Controls -->
                <div id="bossControls" style="display: none;">
                    <button id="daggerBtn" onclick="embeddedGame.daggerLaunch()">🗡️ Dagger Launch</button>
                    <button id="healBtn" onclick="embeddedGame.healPlayer()">💚 Heal</button>
                    <button id="sonicBtn" onclick="embeddedGame.sonicBlast()">💥 Sonic Blast</button>
                </div>
                
                <!-- Game Messages -->
                <div id="gameMessage" class="game-message" style="display: none;">
                    <div id="messageText"></div>
                    <button id="restartBtn" onclick="resetEmbeddedGame()">Try Again</button>
                </div>
                
                <!-- Admin Status -->
                <div id="adminStatusGame">👑 ADMIN MODE</div>
            </div>
            
            <!-- Game Canvas -->
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="admin-controls.js"></script>
    <script>
        // Copy the full ClaireGame class for embedded use
        class EmbeddedClaireGame {
            constructor(canvas) {
                // Set up Three.js with the provided canvas
                this.canvas = canvas;
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                this.clock = new THREE.Clock();
                
                // Configure renderer
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.scene.background = new THREE.Color(0x87CEEB);
                
                // Game state
                this.gameState = 'playing';
                this.stars = 0;
                this.lives = 3;
                this.respawnPosition = new THREE.Vector3(0, 1, 0);
                
                // Power-up state
                this.powerUpActive = false;
                this.powerUpTimer = 0;
                this.powerUpDuration = 5;
                
                // Boss state
                this.bossHealth = 100;
                this.bossMaxHealth = 100;
                this.bossAttackTimer = 0;
                this.bossAttackCooldown = 3;
                
                // Player health for boss fights
                this.playerHealth = 100;
                this.playerMaxHealth = 100;
                this.originalPlayer = null;
                this.playerBattleForm = null;
                
                // Ability cooldowns
                this.lastDaggerTime = 0;
                this.lastHealTime = 0;
                this.lastSonicTime = 0;
                this.daggerCooldown = 2;
                this.healCooldown = 8;
                this.sonicCooldown = 5;
                
                // Battle effects
                this.battleEffects = [];
                this.endingCubes = [];
                this.teleportParticles = [];
                this.returnParticles = [];
                
                // Admin system - ALWAYS ENABLED for embedded game
                this.adminMode = true;
                this.godMode = false;
                this.infiniteLives = false;
                this.speedMultiplier = 1.0;
                this.jumpMultiplier = 1.0;
                this.deathCount = 0;
                this.physicsEnabled = true;
                this.gamePaused = false;
                this.particlesEnabled = true;
                this.rainbowTrail = false;
                this.discoLights = false;
                this.superSpeed = false;
                this.pathTracking = false;
                this.timeScale = 1.0;
                this.sessionStartTime = Date.now();
                
                // Player properties
                this.player = null;
                this.playerVelocity = new THREE.Vector3();
                this.isGrounded = false;
                this.isFlying = false;
                this.jumpCount = 0;
                this.maxJumps = 2;
                
                // Input handling
                this.keys = {};
                this.spacePressed = false;
                this.mouseX = 0;
                this.mouseY = 0;
                
                // Game objects
                this.platforms = [];
                this.spikes = [];
                this.starObjects = [];
                this.turtles = [];
                this.powerUpCube = null;
                this.boss = null;
                this.arenaPlatform = null;
                this.arenaLight = null;
                
                // Mobile controls
                this.isMobile = this.detectMobile();
                this.joystickData = { x: 0, y: 0, active: false };
                this.mobileInputs = { jump: false, flyUp: false, flyDown: false };
                this.lastButtonPress = 0;
                this.buttonDebounceTime = 300;
                
                // Initialize the game
                this.init();
            }

            detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            init() {
                this.setupScene();
                this.createPlayer();
                this.createPlatforms();
                this.createStars();
                this.createTurtles();
                this.createPowerUpCube();
                this.setupLighting();
                this.setupEventListeners();
                this.gameLoop();
                
                console.log('🎮 Embedded Claire\'s Adventure initialized with admin mode enabled!');
            }

            setupScene() {
                // Ground
                const groundGeometry = new THREE.PlaneGeometry(200, 200);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
                this.ground = new THREE.Mesh(groundGeometry, groundMaterial);
                this.ground.rotation.x = -Math.PI / 2;
                this.ground.receiveShadow = true;
                this.scene.add(this.ground);
            }

            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // Directional light
                this.directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                this.directionalLight.position.set(10, 10, 5);
                this.directionalLight.castShadow = true;
                this.directionalLight.shadow.mapSize.width = 2048;
                this.directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(this.directionalLight);
            }

            createPlayer() {
                const playerGeometry = new THREE.CylinderGeometry(0.5, 0.5, 2, 8);
                const playerMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
                this.player = new THREE.Mesh(playerGeometry, playerMaterial);
                this.player.position.copy(this.respawnPosition);
                this.player.castShadow = true;
                this.scene.add(this.player);
                
                // Set up camera
                this.camera.position.set(-8, 6, 0);
                this.camera.lookAt(this.player.position);
            }

            createPlatforms() {
                this.platforms = [];
                
                // Create platform groups with spikes
                for (let i = 0; i < 5; i++) {
                    const baseX = i * 12 + 5;
                    const baseY = Math.random() * 3 + 2;
                    
                    // Create 3 connected platforms
                    for (let j = 0; j < 3; j++) {
                        const platformGeometry = new THREE.BoxGeometry(4, 0.5, 4);
                        const platformMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                        const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                        platform.position.set(baseX + j * 4, baseY, 0);
                        platform.castShadow = true;
                        platform.receiveShadow = true;
                        this.scene.add(platform);
                        this.platforms.push(platform);
                        
                        // Add spikes to middle platform
                        if (j === 1) {
                            this.createSpike(baseX + j * 4, baseY + 0.75, 0);
                        }
                    }
                }
            }

            createSpike(x, y, z) {
                const spikeGeometry = new THREE.ConeGeometry(0.5, 1.5, 8);
                const spikeMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
                const spike = new THREE.Mesh(spikeGeometry, spikeMaterial);
                spike.position.set(x, y, z);
                spike.castShadow = true;
                this.scene.add(spike);
                this.spikes.push(spike);
            }

            createStars() {
                this.starObjects = [];
                for (let i = 0; i < 8; i++) {
                    const starGeometry = new THREE.SphereGeometry(0.3, 8, 6);
                    const starMaterial = new THREE.MeshLambertMaterial({
                        color: 0xffff00,
                        emissive: 0xffff00,
                        emissiveIntensity: 0.3
                    });
                    const star = new THREE.Mesh(starGeometry, starMaterial);
                    star.position.set(
                        Math.random() * 50 + 5,
                        Math.random() * 5 + 3,
                        (Math.random() - 0.5) * 10
                    );
                    this.scene.add(star);
                    this.starObjects.push(star);
                }
            }

            createTurtles() {
                this.turtles = [];
                for (let i = 0; i < 2; i++) {
                    const turtleGeometry = new THREE.SphereGeometry(0.8, 8, 6);
                    const turtleMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
                    const turtle = new THREE.Mesh(turtleGeometry, turtleMaterial);
                    turtle.position.set(
                        15 + i * 20,
                        2,
                        (Math.random() - 0.5) * 8
                    );
                    turtle.direction = Math.random() > 0.5 ? 1 : -1;
                    turtle.speed = 0.01;
                    turtle.castShadow = true;
                    this.scene.add(turtle);
                    this.turtles.push(turtle);
                }
            }

            createPowerUpCube() {
                const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
                const cubeMaterial = new THREE.MeshLambertMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700,
                    emissiveIntensity: 0.3
                });
                this.powerUpCube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                this.powerUpCube.position.set(30, 4, 0);
                this.powerUpCube.castShadow = true;
                this.scene.add(this.powerUpCube);
            }

            setupEventListeners() {
                // Handle window resize
                window.addEventListener('resize', () => this.handleResize());
                
                // Keyboard events
                document.addEventListener('keydown', (event) => this.onKeyDown(event));
                document.addEventListener('keyup', (event) => this.onKeyUp(event));
            }

            handleResize() {
                if (this.canvas) {
                    const rect = this.canvas.getBoundingClientRect();
                    this.camera.aspect = rect.width / rect.height;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(rect.width, rect.height);
                }
            }

            onKeyDown(event) {
                this.keys[event.code] = true;
                
                if (event.code === 'Space') {
                    event.preventDefault();
                    if (!this.spacePressed) {
                        this.jump();
                        this.spacePressed = true;
                    }
                }
            }

            onKeyUp(event) {
                this.keys[event.code] = false;
                
                if (event.code === 'Space') {
                    this.spacePressed = false;
                }
            }

            jump() {
                if (this.jumpCount < this.maxJumps) {
                    this.playerVelocity.y = 0.25 * this.jumpMultiplier;
                    this.jumpCount++;
                    this.isGrounded = false;
                }
            }

            updatePlayer() {
                if (!this.physicsEnabled || this.gamePaused) return;
                
                const deltaTime = this.clock.getDelta() * this.timeScale;
                
                // Movement
                const speed = this.powerUpActive ? 0.2 * this.speedMultiplier : 0.1 * this.speedMultiplier;
                
                if (this.keys['KeyA'] || this.keys['ArrowLeft']) {
                    this.playerVelocity.x -= speed;
                }
                if (this.keys['KeyD'] || this.keys['ArrowRight']) {
                    this.playerVelocity.x += speed;
                }
                if (this.keys['KeyW'] || this.keys['ArrowUp']) {
                    this.playerVelocity.z -= speed;
                }
                if (this.keys['KeyS'] || this.keys['ArrowDown']) {
                    this.playerVelocity.z += speed;
                }
                
                // Flying controls during power-up
                if (this.powerUpActive) {
                    if (this.keys['KeyQ']) {
                        this.playerVelocity.y += 0.1;
                    }
                    if (this.keys['KeyE']) {
                        this.playerVelocity.y -= 0.1;
                    }
                } else {
                    // Gravity
                    this.playerVelocity.y -= 0.02;
                }
                
                // Apply velocity
                this.player.position.add(this.playerVelocity);
                
                // Ground collision (only near starting area to allow falling detection)
                if (this.player.position.y <= 1 && this.player.position.x < 5) {
                    this.player.position.y = 1;
                    this.playerVelocity.y = 0;
                    this.isGrounded = true;
                    this.jumpCount = 0;
                }
                
                // Platform collision
                this.checkPlatformCollisions();
                
                // Apply friction
                this.playerVelocity.x *= 0.8;
                this.playerVelocity.z *= 0.8;
                
                // Update camera
                this.camera.position.x = this.player.position.x - 8;
                this.camera.position.y = this.player.position.y + 5;
                this.camera.lookAt(this.player.position);
                
                // Check if player fell off the world
                if (this.player.position.y < -2) {
                    console.log(`💀 Player fell off the world! Position: x=${this.player.position.x.toFixed(2)}, y=${this.player.position.y.toFixed(2)}, z=${this.player.position.z.toFixed(2)}`);
                    console.log(`💀 Lives before: ${this.lives}, God Mode: ${this.godMode}, Infinite Lives: ${this.infiniteLives}`);
                    this.takeDamage();
                }
            }

            checkPlatformCollisions() {
                this.platforms.forEach(platform => {
                    const playerBox = new THREE.Box3().setFromObject(this.player);
                    const platformBox = new THREE.Box3().setFromObject(platform);
                    
                    if (playerBox.intersectsBox(platformBox)) {
                        // Landing on top
                        if (this.playerVelocity.y < 0 && 
                            this.player.position.y > platform.position.y + 0.25) {
                            this.player.position.y = platform.position.y + 1;
                            this.playerVelocity.y = 0;
                            this.isGrounded = true;
                            this.jumpCount = 0;
                        }
                    }
                });
            }

            updateUI() {
                const starsEl = document.getElementById('stars');
                const livesEl = document.getElementById('lives');
                const powerupEl = document.getElementById('powerupStatus');
                const powerupTimerEl = document.getElementById('powerupTimer');
                
                if (starsEl) starsEl.textContent = `⭐ Stars: ${this.stars}`;
                if (livesEl) livesEl.textContent = `❤️ Lives: ${this.lives}`;
                
                if (powerupEl && powerupTimerEl) {
                    if (this.powerUpActive) {
                        powerupEl.style.display = 'block';
                        powerupTimerEl.textContent = Math.ceil(this.powerUpTimer);
                    } else {
                        powerupEl.style.display = 'none';
                    }
                }
            }

            gameLoop() {
                requestAnimationFrame(() => this.gameLoop());
                
                if (!this.gamePaused) {
                    this.updatePlayer();
                    this.updateStars();
                    this.updateTurtles();
                    this.updatePowerUp();
                    this.updateCollisions();
                    this.updateUI();
                }
                
                this.renderer.render(this.scene, this.camera);
            }

            updateStars() {
                this.starObjects.forEach((star, index) => {
                    star.rotation.y += 0.02;
                    star.position.y += Math.sin(Date.now() * 0.003 + index) * 0.01;
                    
                    // Collision with player
                    const distance = this.player.position.distanceTo(star.position);
                    if (distance < 1) {
                        this.scene.remove(star);
                        this.starObjects.splice(index, 1);
                        this.stars++;
                        console.log('⭐ Star collected! Total:', this.stars);
                    }
                });
            }

            updateTurtles() {
                this.turtles.forEach(turtle => {
                    turtle.position.x += turtle.direction * turtle.speed;
                    
                    // Reverse direction occasionally
                    if (Math.random() < 0.001) {
                        turtle.direction *= -1;
                    }
                    
                    // Collision with player
                    const distance = this.player.position.distanceTo(turtle.position);
                    if (distance < 1.5 && !this.godMode) {
                        this.takeDamage();
                    }
                });
            }

            updatePowerUp() {
                if (this.powerUpCube) {
                    this.powerUpCube.rotation.y += 0.03;
                    this.powerUpCube.position.y += Math.sin(Date.now() * 0.005) * 0.02;
                    
                    // Collision with player
                    const distance = this.player.position.distanceTo(this.powerUpCube.position);
                    if (distance < 1.5) {
                        this.activatePowerUp();
                        this.scene.remove(this.powerUpCube);
                        this.powerUpCube = null;
                    }
                }
                
                // Update power-up timer
                if (this.powerUpActive) {
                    this.powerUpTimer -= this.clock.getDelta();
                    if (this.powerUpTimer <= 0) {
                        this.deactivatePowerUp();
                    }
                }
            }

            updateCollisions() {
                // Spike collisions
                this.spikes.forEach(spike => {
                    const distance = this.player.position.distanceTo(spike.position);
                    if (distance < 1 && !this.godMode) {
                        this.takeDamage();
                    }
                });
            }

            activatePowerUp() {
                this.powerUpActive = true;
                this.powerUpTimer = this.powerUpDuration;
                this.isFlying = true;
                console.log('⚡ Claire is Awesome mode activated!');
            }

            deactivatePowerUp() {
                this.powerUpActive = false;
                this.isFlying = false;
                console.log('⚡ Claire is Awesome mode ended');
            }

            takeDamage() {
                if (this.godMode || this.infiniteLives) return;
                
                this.lives--;
                this.deathCount++;
                
                if (this.lives <= 0) {
                    this.gameOver();
                } else {
                    this.respawn();
                }
            }

            respawn() {
                this.player.position.copy(this.respawnPosition);
                this.playerVelocity.set(0, 0, 0);
                console.log('💀 Player respawned. Lives remaining:', this.lives);
            }

            gameOver() {
                this.gameState = 'gameOver';
                console.log('💀 Game Over!');
                
                const messageEl = document.getElementById('gameMessage');
                const messageTextEl = document.getElementById('messageText');
                if (messageEl && messageTextEl) {
                    messageTextEl.textContent = 'Game Over! Try again?';
                    messageEl.style.display = 'block';
                }
            }

            resetLevel() {
                this.lives = 3;
                this.stars = 0;
                this.gameState = 'playing';
                this.deathCount = 0;
                this.player.position.copy(this.respawnPosition);
                this.playerVelocity.set(0, 0, 0);
                this.deactivatePowerUp();
                
                // Hide game message
                const messageEl = document.getElementById('gameMessage');
                if (messageEl) messageEl.style.display = 'none';
                
                console.log('🔄 Level reset');
            }

            // Admin API methods
            setGodMode(enabled) { this.godMode = enabled; }
            setInfiniteLives(enabled) { this.infiniteLives = enabled; }
            setSpeedMultiplier(multiplier) { this.speedMultiplier = multiplier; }
            setJumpHeight(multiplier) { this.jumpMultiplier = multiplier; }
            setStarCount(count) { this.stars = Math.max(0, count); }
            teleportPlayer(x, y, z) { this.player.position.set(x, y, z); }
            setPhysicsEnabled(enabled) { this.physicsEnabled = enabled; }
            setPaused(paused) { this.gamePaused = paused; }
            setWireframeMode(enabled) {
                this.scene.traverse((object) => {
                    if (object.material) {
                        object.material.wireframe = enabled;
                    }
                });
            }
            setLightingBrightness(brightness) {
                if (this.directionalLight) {
                    this.directionalLight.intensity = brightness;
                }
            }
            setGridEnabled(enabled) {
                if (enabled && !this.gridHelper) {
                    this.gridHelper = new THREE.GridHelper(50, 25);
                    this.scene.add(this.gridHelper);
                } else if (!enabled && this.gridHelper) {
                    this.scene.remove(this.gridHelper);
                    this.gridHelper = null;
                }
            }
            setPlayerScale(scale) {
                if (this.player) {
                    this.player.scale.set(scale, scale, scale);
                }
            }
            
            // Placeholder methods
            skipToVictory() { console.log('👑 Skip to Victory'); }
            unlockAllAreas() { console.log('👑 Unlock All Areas'); }
            setBossHealth(percentage) { console.log('👑 Boss Health:', percentage + '%'); }
            setPlayerHealth(percentage) { console.log('👑 Player Health:', percentage + '%'); }
            skipBossPrep() { console.log('👑 Skip Boss Prep'); }
            resetBossFight() { console.log('👑 Reset Boss Fight'); }
            triggerBossAbility(type) { console.log('👑 Boss Ability:', type); }
            setParticlesEnabled(enabled) { console.log('👑 Particles:', enabled ? 'ON' : 'OFF'); }
            setRainbowTrail(enabled) { console.log('👑 Rainbow Trail:', enabled ? 'ON' : 'OFF'); }
            setDiscoLights(enabled) { console.log('👑 Disco Lights:', enabled ? 'ON' : 'OFF'); }
            setSuperSpeed(enabled) { 
                this.superSpeed = enabled;
                this.timeScale = enabled ? 0.3 : 1.0;
                console.log('👑 Super Speed:', enabled ? 'ON' : 'OFF'); 
            }
            setPathTracking(enabled) { console.log('👑 Path Tracking:', enabled ? 'ON' : 'OFF'); }
            clearAnalytics() { 
                this.deathCount = 0;
                console.log('👑 Analytics Cleared'); 
            }
            
            // Boss fight methods (placeholders for now)
            daggerLaunch() { console.log('🗡️ Dagger Launch!'); }
            healPlayer() { 
                this.playerHealth = Math.min(100, this.playerHealth + 25);
                console.log('💚 Player healed!'); 
            }
            sonicBlast() { console.log('💥 Sonic Blast!'); }
        }
        
        // Global functions
        function resetEmbeddedGame() {
            if (window.embeddedGame) {
                window.embeddedGame.resetLevel();
            }
        }
        
        function toggleGameFullscreen() {
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    gameContainer.requestFullscreen().catch(err => {
                        console.log('Fullscreen failed:', err);
                    });
                }
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                try {
                    console.log('🚀 Starting full embedded game initialization...');
                    const canvas = document.getElementById('gameCanvas');
                    if (canvas) {
                        window.embeddedGame = new EmbeddedClaireGame(canvas);
                        
                        // Connect to admin system
                        if (window.adminSystem) {
                            window.adminSystem.gameInstance = window.embeddedGame;
                            console.log('🔗 Connected to admin system');
                        }
                        
                        // Update game status
                        const statusEl = document.getElementById('gameStatus');
                        if (statusEl) statusEl.textContent = 'Running - Full Game';
                        
                    } else {
                        console.error('Game canvas not found!');
                    }
                } catch (error) {
                    console.error('❌ Failed to initialize embedded game:', error);
                    
                    // Update game status
                    const statusEl = document.getElementById('gameStatus');
                    if (statusEl) statusEl.textContent = 'Failed';
                }
            }, 500);
        });
    </script>
</body>
</html> 